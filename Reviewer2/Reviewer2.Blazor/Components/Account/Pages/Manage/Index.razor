@page "/Account/Manage"
@rendermode InteractiveServer

@using System.ComponentModel.DataAnnotations
@using Reviewer2.Services.CRUD.ApplicationUser
@using Reviewer2.Services.DTOs.ApplicationUser

@inject IApplicationUserService UserService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Profile</PageTitle>

<h3>Profile</h3>

@if (!string.IsNullOrWhiteSpace(StatusMessage))
{
    <div class="alert @(IsError ? "alert-danger" : "alert-success")" role="alert">
        @StatusMessage
    </div>
}

@if (!IsLoaded)
{
    <p>Loading...</p>
}
else
{
    <div class="row">
        <div class="col-xl-6">
            <EditForm Model="Input"
                      OnValidSubmit="OnValidSubmitAsync"
                      FormName="ProfileForm"
                      Method="post">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <div class="form-floating mb-3">
                    <InputText @bind-Value="Input.UserName"
                               class="form-control"
                               disabled />
                    <label>Username</label>
                </div>

                <div class="form-floating mb-3">
                    <InputText @bind-Value="Input.FirstName"
                               class="form-control"
                               placeholder="Enter your first name" />
                    <label>First name</label>
                </div>

                <div class="form-floating mb-3">
                    <InputText @bind-Value="Input.LastName"
                               class="form-control"
                               placeholder="Enter your last name" />
                    <label>Last name</label>
                </div>

                <div class="form-floating mb-3">
                    <InputText @bind-Value="Input.PhoneNumber"
                               class="form-control"
                               placeholder="Enter your phone number" />
                    <label>Phone number</label>
                    <ValidationMessage For="() => Input.PhoneNumber" />
                </div>

                <button type="submit" class="w-100 btn btn-lg btn-primary">
                    Save
                </button>
            </EditForm>
        </div>
    </div>
}

@code {
    private InputModel Input { get; set; } = new();
    private string? StatusMessage;
    private bool IsError;
    private bool IsLoaded;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userPrincipal = authState.User;

        if (!userPrincipal.Identity?.IsAuthenticated ?? true)
        {
            StatusMessage = "User is not authenticated.";
            IsError = true;
            IsLoaded = true;
            return;
        }

        var profile = await UserService.GetProfileAsync(userPrincipal);

        if (profile is null)
        {
            StatusMessage = "Unable to load profile.";
            IsError = true;
            IsLoaded = true;
            return;
        }

        Input = new InputModel
        {
            UserName = profile.UserName,
            FirstName = profile.FirstName,
            LastName = profile.LastName,
            PhoneNumber = profile.PhoneNumber
        };

        IsLoaded = true;
    }

    private async Task OnValidSubmitAsync()
    {
        StatusMessage = null;
        IsError = false;

        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userPrincipal = authState.User;

        var profile = await UserService.GetProfileAsync(userPrincipal);

        if (profile is null)
        {
            StatusMessage = "User not found.";
            IsError = true;
            return;
        }

        var result = await UserService.UpdateProfileAsync(
            new UpdateUserProfileRequest(
                profile.UserId,
                Input.UserName,
                Input.FirstName,
                Input.LastName,
                Input.PhoneNumber
            ));

        if (!result.Succeeded)
        {
            StatusMessage = result.ErrorMessage ?? "Update failed.";
            IsError = true;
            return;
        }

        StatusMessage = "Your profile has been updated successfully.";
        IsError = false;
    }

    private sealed class InputModel
    {
        [Required]
        public string UserName { get; set; } = string.Empty;

        public string? FirstName { get; set; }

        public string? LastName { get; set; }

        [Phone]
        public string? PhoneNumber { get; set; }
    }
}
