@* @page "/Account/Manage/Passkeys" *@

@using Reviewer2.Services.DTOs.ApplicationUser.Passkey
@using Reviewer2.Data.Models
@using Reviewer2.Services.CRUD.ApplicationUser

@inject IApplicationUserService UserService
@inject IdentityRedirectManager RedirectManager

<PageTitle>Manage your passkeys</PageTitle>

<h3>Manage your passkeys</h3>

<StatusMessage />

@if (_currentPasskeys is { Count: > 0 })
{
    <table class="table">
        <tbody>
            @foreach (var passkey in _currentPasskeys)
            {
                <tr>
                    <td>@(passkey.Name ?? "Unnamed passkey")</td>
                    <td>
                        <form @formname="@($"update-passkey-{passkey.CredentialId}")"
                              @onsubmit="UpdatePasskey"
                              method="post">
                            <AntiforgeryToken />
                            <div>
                                <input type="hidden"
                                       name="CredentialId"
                                       value="@passkey.CredentialId" />

                                <button type="submit"
                                        name="Action"
                                        value="rename"
                                        class="btn btn-primary"
                                        title="Rename this passkey">
                                    Rename
                                </button>

                                <button type="submit"
                                        name="Action"
                                        value="delete"
                                        class="btn btn-danger"
                                        title="Remove this passkey from your account">
                                    Delete
                                </button>
                            </div>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}
else
{
    <p>No passkeys are registered.</p>
}

<form @formname="add-passkey" @onsubmit="AddPasskey" method="post">
    <AntiforgeryToken />

    @if (_currentPasskeys is { Count: >= MaxPasskeyCount })
    {
        <p class="text-danger">
            You have reached the maximum number of allowed passkeys.
            Please delete one before adding a new one.
        </p>
    }
    else
    {
        <PasskeySubmit Operation="PasskeyOperation.Create"
                       Name="Input"
                       class="btn btn-primary">
            Add a new passkey
        </PasskeySubmit>
    }
</form>

@code {
    private const int MaxPasskeyCount = 100;

    private ApplicationUser? _user;
    private IReadOnlyList<PasskeyDTO>? _currentPasskeys;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private string? Action { get; set; }

    [SupplyParameterFromForm]
    private string? CredentialId { get; set; }

    [SupplyParameterFromForm(FormName = "add-passkey")]
    private PasskeyInputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();

        _user = await UserService.GetCurrentUserAsync(HttpContext.User);

        if (_user is null)
        {
            RedirectManager.RedirectToInvalidUser(null!, HttpContext);
            return;
        }

        _currentPasskeys = await UserService.GetPasskeysAsync(_user.Id);
    }

    private async Task AddPasskey()
    {
        if (_user is null)
        {
            RedirectManager.RedirectToInvalidUser(null!, HttpContext);
            return;
        }

        if (!string.IsNullOrEmpty(Input.Error))
        {
            RedirectManager.RedirectToCurrentPageWithStatus(
                $"Error: {Input.Error}", HttpContext);
            return;
        }

        if (string.IsNullOrEmpty(Input.CredentialJson))
        {
            RedirectManager.RedirectToCurrentPageWithStatus(
                "Error: The browser did not provide a passkey.",
                HttpContext);
            return;
        }

        if (_currentPasskeys is { Count: >= MaxPasskeyCount })
        {
            RedirectManager.RedirectToCurrentPageWithStatus(
                "Error: You have reached the maximum number of allowed passkeys.",
                HttpContext);
            return;
        }

        var result = await UserService.AddPasskeyAsync(
            _user.Id,
            Input.CredentialJson);

        if (!result.Succeeded)
        {
            RedirectManager.RedirectToCurrentPageWithStatus(
                $"Error: {result.ErrorMessage}",
                HttpContext);
            return;
        }

        RedirectManager.RedirectTo(
            $"Account/Manage/RenamePasskey/{result.CredentialId}");
    }

    private async Task UpdatePasskey()
    {
        switch (Action)
        {
            case "rename":
                RedirectManager.RedirectTo(
                    $"Account/Manage/RenamePasskey/{CredentialId}");
                break;

            case "delete":
                await DeletePasskey();
                break;

            default:
                RedirectManager.RedirectToCurrentPageWithStatus(
                    $"Error: Unknown action '{Action}'.",
                    HttpContext);
                break;
        }
    }

    private async Task DeletePasskey()
    {
        if (_user is null)
        {
            RedirectManager.RedirectToInvalidUser(null!, HttpContext);
            return;
        }

        if (string.IsNullOrEmpty(CredentialId))
        {
            RedirectManager.RedirectToCurrentPageWithStatus(
                "Error: Invalid passkey.",
                HttpContext);
            return;
        }

        var result = await UserService.DeletePasskeyAsync(
            _user.Id,
            CredentialId);

        if (!result.Succeeded)
        {
            RedirectManager.RedirectToCurrentPageWithStatus(
                $"Error: {result.ErrorMessage}",
                HttpContext);
            return;
        }

        RedirectManager.RedirectToCurrentPageWithStatus(
            "Passkey deleted successfully.",
            HttpContext);
    }
}
