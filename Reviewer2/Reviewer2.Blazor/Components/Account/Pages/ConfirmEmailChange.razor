@page "/Account/ConfirmEmailChange"

@using Reviewer2.Services.CRUD.ApplicationUser

@inject IApplicationUserService ApplicationUserService
@inject IdentityRedirectManager RedirectManager

<PageTitle>Confirm email change</PageTitle>

<h1>Confirm email change</h1>

<StatusMessage Message="@message" />

@code {
    private string? message;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromQuery] private Guid? UserId { get; set; }
    [SupplyParameterFromQuery] private string? Email { get; set; }
    [SupplyParameterFromQuery] private string? Code { get; set; }

    protected override async Task OnInitializedAsync()
    {
        if (UserId is null 
            || string.IsNullOrWhiteSpace(Email) 
            || string.IsNullOrWhiteSpace(Code))
        {
            RedirectManager.RedirectToWithStatus(
                "Account/Login",
                "Error: Invalid email change confirmation link.",
                HttpContext);
            return;
        }

        var result = await ApplicationUserService
            .ConfirmEmailChangeAsync(UserId.Value, Email, Code);

        message = result.Succeeded
            ? "Thank you for confirming your email change."
            : result.ErrorMessage;
    }
}