@page "/submit"
@attribute [Authorize] 
@inject IPaperSubmissionService PaperService
@inject NavigationManager NavManager
@inject AuthenticationStateProvider AuthStateProvider
@using Microsoft.AspNetCore.Authorization
@using Reviewer2.Data.Models
@using Reviewer2.Services.DTOs.FileStorage
@using Reviewer2.Services.DTOs.PaperSubmission
@using Reviewer2.Services.Submissions.PaperSubmission

<h1 class="mb-4">Paper Submission</h1>

<EditForm EditContext="@_editContext" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <!-- Paper Information -->
    <section class="card shadow-sm p-4 mb-4">
        <h3>Paper Information</h3>

        <label class="form-label mt-3">Title*</label>
        <InputText class="form-control" @bind-Value="Title" />
        <ValidationMessage For="@(() => Title)" />

        <label class="form-label mt-3">Abstract*</label>
        <InputTextArea class="form-control" Rows="6" @bind-Value="Abstract" />
        <ValidationMessage For="@(() => Abstract)" />
    </section>

    <!-- Authors Section -->
    <section class="card shadow-sm p-4 mb-4">
        <h3>Authors*</h3>

        <InputRadioGroup TValue="int" @bind-Value="CorrespondingAuthorIndex">
            @foreach (var author in Authors)
            {
                var index = Authors.IndexOf(author);
                <div class="card shadow-sm p-3 mb-3" @key="author">
                    <InputText class="form-control" placeholder="First name" @bind-Value="author.FirstName" />
                    <ValidationMessage For="@(() => author.FirstName)" />

                    <InputText class="form-control mt-2" placeholder="Last name" @bind-Value="author.LastName" />
                    <ValidationMessage For="@(() => author.LastName)" />

                    <InputText class="form-control mt-2" type="email" placeholder="Email" @bind-Value="author.Email" />
                    <ValidationMessage For="@(() => author.Email)" />

                    <div class="form-check mt-2">
                        <InputRadio TValue="int" class="form-check-input" Value="index" />
                        <label class="form-check-label">Corresponding Author</label>
                    </div>

                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" @onclick="() => RemoveAuthor(author)">
                        Remove
                    </button>
                </div>
            }
        </InputRadioGroup>

        <button type="button" class="btn btn-primary mt-2" @onclick="AddAuthor">+ Add Author</button>
    </section>

    <!-- File Upload Section -->
    <section class="card shadow-sm p-4 mb-4">
        <h3>Upload PDF*</h3>
        <InputFile OnChange="HandleFileUpload" accept=".pdf,application/pdf" />

        @if (!string.IsNullOrEmpty(FileError))
        {
            <div class="alert alert-danger mt-2">@FileError</div>
        }

        @if (UploadedFile != null)
        {
            <div class="text-muted mt-1">Selected file: @UploadedFile.Name</div>
        }
    </section>

    <!-- Submit Button -->
    <section class="text-center mt-4">
        <button type="submit" class="btn btn-primary" disabled="@(!CanSubmit || IsSubmitting)">
            @if (IsSubmitting)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>Submitting...</span>
            }
            else
            {
                <span>Submit Paper</span>
            }
        </button>
    </section>
</EditForm>

@code {
    // Paper metadata
    private string Title { get; set; } = string.Empty;
    private string Abstract { get; set; } = string.Empty;
    
    private int CorrespondingAuthorIndex { get; set; } = 0;

    private void UpdateCorrespondingAuthor()
    {
        for (var i = 0; i < Authors.Count; i++)
            Authors[i].IsCorrespondingAuthor = i == CorrespondingAuthorIndex;
    }
    
    private List<AuthorInputDTO> Authors { get; set; } = new() { new AuthorInputDTO() };

    // File upload
    private IBrowserFile? UploadedFile { get; set; }
    private string? FileError { get; set; }

    // Edit form
    private EditContext? _editContext;

    // Submission state
    private bool IsSubmitting { get; set; }

    protected override void OnInitialized()
    {
        _editContext = new EditContext(this);
        _editContext.OnFieldChanged += (_, _) => StateHasChanged();
    }

    // -------------------------------
    // User helper
    // -------------------------------
    private async Task<Guid> GetSubmitterUserIdAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity!.IsAuthenticated)
            throw new InvalidOperationException("User is not authenticated.");

        // Identity stores the user ID in ClaimTypes.NameIdentifier
        var claim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)
                    ?? throw new InvalidOperationException("User ID claim not found.");

        return Guid.Parse(claim.Value);
    }

    // -------------------------------
    // Authors management
    // -------------------------------
    private void AddAuthor() => Authors.Add(new AuthorInputDTO());

    private void RemoveAuthor(AuthorInputDTO author)
    {
        if (Authors.Count > 1)
            Authors.Remove(author);
    }

    // -------------------------------
    // File upload
    // -------------------------------
    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        FileError = null;
        var file = e.File;

        if (file.ContentType != "application/pdf" || !file.Name.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
        {
            FileError = "Only PDF files are allowed.";
            return;
        }

        if (file.Size > 10 * 1024 * 1024)
        {
            FileError = "PDF must be smaller than 10MB.";
            return;
        }

        UploadedFile = file;
        await Task.CompletedTask;
    }

    // -------------------------------
    // Form validation
    // -------------------------------
    private bool CanSubmit => UploadedFile != null && _editContext?.Validate() == true && !IsSubmitting;

    // -------------------------------
    // Submit handler
    // -------------------------------
    private async Task HandleSubmit()
    {
        if (UploadedFile == null)
        {
            FileError = "A PDF must be uploaded.";
            return;
        }

        IsSubmitting = true;
        FileError = null;

        try
        {
            // 1. Get current user
            var submitterUserId = await GetSubmitterUserIdAsync();

            UpdateCorrespondingAuthor();
            
            // 2. Create draft via service
            var createDraftRequest = new CreateDraftRequest
            {
                Title = Title,
                Abstract = Abstract,
                Authors = Authors
            };

            var draftId = await PaperService.CreateDraftAsync(createDraftRequest, submitterUserId);

            // 3. Upload PDF
            await using var fileStream = UploadedFile.OpenReadStream(10 * 1024 * 1024);
            await using var memoryStream = new MemoryStream();
            await fileStream.CopyToAsync(memoryStream);

            // Reset the position to the beginning so the service can read it
            memoryStream.Position = 0;

            var fileResult = await PaperService.UploadFileAsync(
                draftId,
                FileType.InitialSubmission,
                memoryStream,
                UploadedFile.Name,
                submitterUserId
            );

            if (!fileResult.Exists)
            {
                FileError = fileResult.ErrorMessage ?? "File upload failed for an unknown reason.";
                return;
            }

            // 4. Optionally: submit immediately
            await PaperService.SubmitAsync(draftId, submitterUserId);

            // 5. Navigate to submissions list
            NavManager.NavigateTo("/submissions");
        }
        catch (ArgumentException ex)
        {
            FileError = ex.Message;
        }
        catch (InvalidOperationException ex)
        {
            FileError = "Operation failed: " + ex.Message;
        }
        catch (Exception ex)
        {
            FileError = "Unexpected error: " + ex.Message;
        }
        finally
        {
            IsSubmitting = false;
        }
    }
}